#! /usr/bin/python3
# PYTHON_ARGCOMPLETE_OK

"""
    File: usr/bin/pbt

    Desc:
        Main interface to package build tools (pbt)

    Usage:
        pbt -h
        pbt --help
"""

import os
import argparse
import argcomplete

from pbt import logger
from pbt.builder import Builder

def main():
    """ main """

    builder = Builder()

    # create parser object
    parser = argparse.ArgumentParser(
        prog="pbt",
        description="Package Build Tools"
    )

    # add arguments
    parser.add_argument(
        "-c", "--create-chroot",
        nargs=1,
        type=str,
        metavar="DIST",
        help="create pbuilder/cowbuilder chroot under /var/cache/pbuilder/base-DIST"
    )

    parser.add_argument(
        "-b", "--build-package",
        nargs=2,
        type=str,
        metavar=("DIST", "FLAG"),
        help="build package in DIST chroot, using FLAG for debmake"
    )

    parser.add_argument(
        "-d", "--use-deps",
        action="store_true",
        help="use local dependencies for respective chroot with -b/--build-package"
    )

    parser.add_argument(
        "--show-available-dists",
        action="store_true",
        help="show available dists you can create chroots from"
    )

    parser.add_argument(
        "--show-existing-chroots",
        action="store_true",
        help="show available chroots you can build packages against"
    )

    # enable autocomplete
    argcomplete.autocomplete(parser)

    args = parser.parse_args()

    if args.create_chroot:
        builder.create_chroot(args.create_chroot[0])

    if args.build_package:
        dist = args.build_package[0]
        flag = args.build_package[1]
        builder.build_package(dist, flag, args.use_deps)

    if args.show_available_dists:
        Builder.show_available_dists()

    if args.show_existing_chroots:
        Builder.show_existing_chroots()

if __name__ == '__main__':
    main()
